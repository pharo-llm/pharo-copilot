"
Builds completion result sets using suggestions generated by the Ollama API.

"
Class {
	#name : 'CoPharoCopilotResultSetBuilder',
	#superclass : 'CoResultSetBuilder',
	#category : 'AI-Pharo-Copilot',
	#package : 'AI-Pharo-Copilot'
}

{ #category : 'instance creation' }
CoPharoCopilotResultSetBuilder class >> initializeOnContext: aSystemCompletionContext [ 
    ^ self new
        initializeOnContext: aSystemCompletionContext;
        yourself
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> buildCompletion [

  | textUpToCaret api response content entries fetcher |
  textUpToCaret := completionContext source copyFrom: 1 to: completionContext position.
  api := OllamaAPI new.
  response := api query: textUpToCaret.  "Likely a String"

  "Normalize to the text we want to show"
  content := (response isKindOf: Dictionary)
               ifTrue:  [ response at: #content ifAbsent: [''] ]
               ifFalse: [ response asString ].

  Transcript
    show: 'Copilot raw response: ';
    show: content; cr.



  entries := content isEmpty
               ifTrue:  [ #() ]
               ifFalse: [ { CoCopilotEntry contents: content } ].

  fetcher := CoCollectionFetcher onCollection: entries.
  ^ CoResultSet fetcher: fetcher
]

{ #category : 'initialization' }
CoPharoCopilotResultSetBuilder >> initializeOnContext: aSystemCompletionContext [ 

    completionContext := aSystemCompletionContext
]
