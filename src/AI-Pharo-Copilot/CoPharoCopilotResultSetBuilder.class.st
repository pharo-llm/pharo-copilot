"
Builds completion result sets using suggestions generated by the Ollama API.

"
Class {
	#name : 'CoPharoCopilotResultSetBuilder',
	#superclass : 'CoResultSetBuilder',
	#category : 'AI-Pharo-Copilot',
	#package : 'AI-Pharo-Copilot'
}

{ #category : 'instance creation' }
CoPharoCopilotResultSetBuilder class >> initializeOnContext: aSystemCompletionContext [ 
    ^ self new
        initializeOnContext: aSystemCompletionContext;
        yourself
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> buildCompletion [

| prefix suffix client response content fetcher |
        prefix := completionContext source copyFrom: 1 to: completionContext position.
        suffix := completionContext position < completionContext source size
                ifTrue: [ completionContext source copyFrom: completionContext position + 1 to: completionContext source size ]
                ifFalse: [ '' ].


client := OllamaClient new.
        response := client generateForPrefix: prefix suffix: suffix.

content := self cleanedContentFrom: response asString.

content isEmpty ifFalse: [ completionContext replaceTokenInEditorWith: content ].


fetcher := CoCollectionFetcher onCollection: #(  ).
        ^ CoResultSet fetcher: fetcher
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> cleanedContentFrom: aString [ 
    | start end delimiter idx segment |

self halt.
    start := aString indexOfSubCollection: '```' startingAt: 1 ifAbsent: [ 0 ].
    start > 0 ifTrue: [
        end := aString indexOfSubCollection: '```' startingAt: start + 3 ifAbsent: [ aString size + 1 ].
        segment := aString copyFrom: start + 3 to: end - 1.
        ^ segment trimBoth
    ].
    delimiter := String lf, String lf.
    idx := aString indexOfSubCollection: delimiter startingAt: 1 ifAbsent: [ 0 ].
    segment := idx = 0
        ifTrue: [ aString ]
        ifFalse: [ aString copyFrom: 1 to: idx - 1 ].
    ^ segment trimBoth
]

{ #category : 'initialization' }
CoPharoCopilotResultSetBuilder >> initializeOnContext: aSystemCompletionContext [ 

    completionContext := aSystemCompletionContext
]
