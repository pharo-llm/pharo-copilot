"
Builds completion result sets using suggestions generated by the Ollama API.

"
Class {
	#name : 'CoPharoCopilotResultSetBuilder',
	#superclass : 'CoResultSetBuilder',
	#category : 'AI-Pharo-Copilot',
	#package : 'AI-Pharo-Copilot'
}

{ #category : 'instance creation' }
CoPharoCopilotResultSetBuilder class >> initializeOnContext: aSystemCompletionContext [ 
    ^ self new
        initializeOnContext: aSystemCompletionContext;
        yourself
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> buildCompletion [

        | context prefix suffix contextInfo process fetcher |
        context := completionContext.
        prefix := context source copyFrom: 1 to: context position.
        suffix := context position < context source size
                          ifTrue: [ context source copyFrom: context position + 1 to: context source size ]
		          ifFalse: [ '' ].
	contextInfo := Dictionary new
		               at: #contextClass put: context class name;
		               at: #cursorPosition put: context position;
		               at: #sourceSize put: context source size;
		               at: #fullSource put: context source;
		               at: #prefix put: prefix;
		               at: #suffix put: suffix;
		               yourself.
		        process := [
                self
                        processCompletionFor: context
                        prefix: prefix
                        suffix: suffix
                        contextInfo: contextInfo ] forkAt: Processor userBackgroundPriority.
	

	
	CoCopilotLogger logBackEndEvent: 'Dispatched asynchronous completion fetch' details: (Dictionary new
                        at: #processPriority put: Processor userBackgroundPriority;
                        at: #processId put: process identityHash;
			 yourself).

	fetcher := CoCollectionFetcher onCollection: #(  ).
	^ CoResultSet fetcher: fetcher
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> classContextFor: aContext [

        | behavior compiledMethod methodClass classDefinition instanceSide classSide |
        behavior := (aContext respondsTo: #behavior)
                ifTrue: [ [ aContext behavior ] on: Error do: [ nil ] ]
                ifFalse: [ nil ].
        compiledMethod := (aContext respondsTo: #method)
                ifTrue: [ [ aContext method ] on: Error do: [ nil ] ]
                ifFalse: [ nil ].
        methodClass := behavior ifNil: [ compiledMethod ifNotNil: [ compiledMethod methodClass ] ] ifNotNil: [ behavior ].
        classDefinition := self safeDefinitionStringFor: methodClass.
        instanceSide := self methodSourcesFor: methodClass.
        classSide := self methodSourcesFor: (methodClass ifNotNil: [ methodClass class ]).
        ^ self
                classDefinition: classDefinition
                instanceMethods: instanceSide
                classMethods: classSide
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> classDefinition: classDefinitionString instanceMethods: instanceMethodsString classMethods: classMethodsString [

        | hasDefinition hasInstance hasClass |
        hasDefinition := classDefinitionString isEmpty not.
        hasInstance := instanceMethodsString isEmpty not.
        hasClass := classMethodsString isEmpty not.
        (hasDefinition or: [ hasInstance or: hasClass ]) ifFalse: [ ^ '' ].
        ^ String streamContents: [ :stream |
                hasDefinition ifTrue: [
                        stream
                                nextPutAll: 'Class Definition:';
                                cr;
                                nextPutAll: classDefinitionString;
                                cr;
                                cr ].
                hasInstance ifTrue: [
                        stream
                                nextPutAll: 'Instance Side Methods:';
                                cr;
                                nextPutAll: instanceMethodsString;
                                cr ].
                hasClass ifTrue: [
                        stream
                                nextPutAll: 'Class Side Methods:';
                                cr;
                                nextPutAll: classMethodsString ] ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> cleanedContentFrom: aString [

	| text start rest closingIndex body newlineIndex firstLine delimiter idx |
        text := (aString ifNil: [ '' ]) asString.
        text isEmpty ifTrue: [ ^ '' ].

        start := text indexOfSubCollection: '```' startingAt: 1 ifAbsent: [ 0 ].
        start > 0 ifTrue: [
                rest := start + 3 <= text size
                        ifTrue: [ text copyFrom: start + 3 to: text size ]
                        ifFalse: [ '' ].
                closingIndex := self indexOfClosingFenceIn: rest startingAt: 1.
                closingIndex := closingIndex = 0
                        ifTrue: [ rest size + 1 ]
                        ifFalse: [ closingIndex ].
                body := closingIndex <= 1
                        ifTrue: [ '' ]
                        ifFalse: [ rest copyFrom: 1 to: closingIndex - 1 ].
                newlineIndex := body indexOf: Character lf ifAbsent: [ 0 ].
                newlineIndex > 0
                        ifTrue: [
                                firstLine := body copyFrom: 1 to: newlineIndex - 1.
                                (firstLine isEmpty or: [ self isLanguageSpec: firstLine ]) ifTrue: [
                                        body := newlineIndex < body size
                                                ifTrue: [ body copyFrom: newlineIndex + 1 to: body size ]
                                                ifFalse: [ '' ] ] ]
                        ifFalse: [
                                (self isLanguageSpec: body) ifTrue: [ body := '' ] ].
                ^ body trimBoth ].

        delimiter := String lf , String lf.
        idx := text indexOfSubCollection: delimiter startingAt: 1 ifAbsent: [ 0 ].
        body := idx = 0
                        ifTrue: [ text ]
                        ifFalse: [ text copyFrom: 1 to: idx - 1 ].
        ^ body trimBoth
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> indexOfClosingFenceIn: text startingAt: startIndex [ 

        | idx lastValid size |
        text isEmpty ifTrue: [ ^ 0 ].
        size := text size.
        lastValid := 0.
        idx := text indexOfSubCollection: '```' startingAt: startIndex ifAbsent: [ 0 ].
        [ idx > 0 ] whileTrue: [
                | before after |
                before := idx = 1 or: [
                        | prev |
                        prev := text at: idx - 1.
                        prev = Character lf or: [ prev = Character cr ] ].
                after := (idx + 3 > size)
                        or: [ | next |
                                next := text at: idx + 3.
                                next = Character lf or: [ next = Character cr ] ].
                (before and: after) ifTrue: [ lastValid := idx ].
                idx := text indexOfSubCollection: '```' startingAt: idx + 1 ifAbsent: [ 0 ].
        ].
        ^ lastValid
]

{ #category : 'initialization' }
CoPharoCopilotResultSetBuilder >> initializeOnContext: aSystemCompletionContext [ 

    completionContext := aSystemCompletionContext
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> isLanguageSpec: aString [

	        | candidate trimmed |
        aString ifNil: [ ^ false ].
        candidate := aString asString.
        candidate isEmpty ifTrue: [ ^ false ].
        trimmed := candidate trimBoth.
        (trimmed size = candidate size) ifFalse: [ ^ false ].
        candidate := trimmed.
        ^ (#('smalltalk' 'pharo' 'bash' 'sh' 'shell' 'python'
                'javascript' 'json' 'java' 'c' 'cpp' 'xml' 'html'
                'ruby' 'php' 'sql' 'yaml' 'yml' 'go' 'rust' 'typescript')
                includes: candidate asLowercase)
                or: [ candidate allSatisfy: [ :ch |
                                ch isLetter
                                        or: [ ch isDigit
                                        or: [ '#+-_' includes: ch ] ] ] ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> methodSourcesFor: aBehavior [

        aBehavior ifNil: [ ^ '' ].
        ^ String streamContents: [ :stream |
                [ (aBehavior selectors asSortedCollection) do: [ :selector |
                        | source |
                        source := [ aBehavior sourceCodeAt: selector ] on: Error do: [ nil ].
                        source ifNotNil: [
                                stream
                                        nextPutAll: source;
                                        cr;
                                        cr ] ] ]
                        on: Error
                        do: [ ] ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> processCompletionFor: aContext prefix: prefixString suffix: suffixString contextInfo: contextInfo [

	| classContext |
	[
		| client rawResponse rawResponseString content |
		CoCopilotLogger logFrontEndEvent: 'Preparing completion request' details: contextInfo.

		client := OllamaClient new.
		                classContext := self classContextFor: aContext.
                contextInfo
                        at: #classContextLength put: classContext size;
                        at: #classContextPresent put: classContext isEmpty not.
                rawResponse := client
                        generateForPrefix: prefixString
                        suffix: suffixString
                        context: classContext.
		rawResponseString := [ rawResponse asString ]
			                     on: Error
			                     do: [ rawResponse printString ].
		CoCopilotLogger logBackEndEvent: 'Received raw suggestion payload' details: (Dictionary new
				 at: #rawResponseClass put: rawResponse class name;
				 at: #rawResponse put: rawResponseString;
				 yourself).
		content := rawResponseString.
		[
			| parsed |
			parsed := STONJSON fromString: rawResponseString.
			(parsed isKindOf: Dictionary) ifTrue: [
				content := parsed at: #response ifAbsent: [ parsed at: 'response' ifAbsent: [ rawResponseString ] ] ] ]
			on: Error
			do: [ :ex |
					CoCopilotLogger logBackEndEvent: 'Failed to parse suggestion payload as JSON' details: (Dictionary new
							 at: #error put: ex messageText;
							 at: #rawResponse put: rawResponseString;
							 yourself) ].

		content := self cleanedContentFrom: content asString.
		CoCopilotLogger logBackEndEvent: 'Normalized suggestion content' details: (Dictionary new
				 at: #cleanedContent put: content;
				 at: #cleanedLength put: content size;
				 yourself).

		content isEmpty
			ifFalse: [
					aContext
						ifNil: [
								CoCopilotLogger logFrontEndEvent: 'Skipped applying suggestion - missing context' details: (Dictionary new
										 at: #appliedContent put: content;
										 at: #appliedLength put: content size;
										 at: #reason put: 'Completion context was nil';
										 yourself) ]
						ifNotNil: [
								aContext replaceTokenInEditorWith: content.
								CoCopilotLogger logFrontEndEvent: 'Applied suggestion to editor' details: (Dictionary new
										 at: #appliedContent put: content;
										 at: #appliedLength put: content size;
										 yourself) ] ]
			ifTrue: [
					CoCopilotLogger logFrontEndEvent: 'No suggestion content to apply' details: (Dictionary new
							 at: #reason put: 'Generated content was empty';
							 at: #rawResponse put: rawResponseString;
							 yourself) ] ]
		on: Error
		do: [ :ex |
				CoCopilotLogger
					logError: 'Asynchronous completion failed'
					origin: #CoPharoCopilotResultSetBuilder
					exception: ex
					payload: (Dictionary new
							 at: #requestDetails put: contextInfo copy;
							 at: #prefixLength put: prefixString size;
							 at: #suffixLength put: suffixString size;
							 yourself) ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> safeDefinitionStringFor: aBehavior [

        aBehavior ifNil: [ ^ '' ].
        ^ [ aBehavior definition asString ] on: Error do: [ '' ]
]
